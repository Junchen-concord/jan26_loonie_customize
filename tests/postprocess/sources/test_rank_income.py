from data import PostProcessTestData
from test_benefit_source import expected_benefit_source_dict
from test_gig_source import expected_gig_source_dict
from test_income_source import expected_payroll_source_dict
from test_transfer_source import expected_transf_source_dict

from postprocess.sources.helpers.rank_income import rank_income_sources

expected_income_json_sorted = {
    "accountGuid": {
        "0": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "1": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "2": "AMpRdoAVarH4VZbV55XDHyMxLkEknYfY76BK5",
        "3": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "4": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "5": "kPvjdQ8XK6hD3RE311j8fp7Mg9Z9R6F6qRDQd",
        "6": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
        "7": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
        "8": "AMpRdoAVarH4VZbV55XDHyMxLkEknYfY76BK5",
        "9": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "10": "kPvjdQ8XK6hD3RE311j8fp7Mg9Z9R6F6qRDQd",
        "11": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
        "12": "AMpRdoAVarH4VZbV55XDHyMxLkEknYfY76BK5",
        "13": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "14": "kPvjdQ8XK6hD3RE311j8fp7Mg9Z9R6F6qRDQd",
        "15": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
    },
    "sourceID": {
        "0": "I1",
        "1": "None",
        "2": "None",
        "3": "None",
        "4": "None",
        "5": "None",
        "6": "None",
        "7": "None",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "sourceName": {
        "0": "TRUIST BANK DES:TRUIST PAY ID:XXXXX0277195 INDN:PETER WAYNE CO ID:XXXXX74313 PPD",
        "1": "CAPGEMINI DES:REG.SALARY ID:CGA50481295 INDN:WAYNE PETER CO ID:XXXXX75929 PPD",
        "2": "balance transfer",
        "3": "balance transfer",
        "4": "venmo",
        "5": "balance transfer",
        "6": "balance transfer",
        "7": "other transfer",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "sourceType": {
        "0": "None",
        "1": "None",
        "2": "None",
        "3": "None",
        "4": "None",
        "5": "None",
        "6": "None",
        "7": "None",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "sourceChannel": {
        "0": "None",
        "1": "None",
        "2": "None",
        "3": "None",
        "4": "None",
        "5": "None",
        "6": "None",
        "7": "None",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "numOfPay": {
        "0": 24,
        "1": 2,
        "2": 28,
        "3": 29,
        "4": 9,
        "5": 27,
        "6": 13,
        "7": 1,
        "8": 0,
        "9": 0,
        "10": 0,
        "11": 0,
        "12": 0,
        "13": 0,
        "14": 0,
        "15": 0,
    },
    "numOfPayMonthly": {
        "0": 2,
        "1": 2,
        "2": 0,
        "3": 0,
        "4": 0,
        "5": 0,
        "6": 0,
        "7": 0,
        "8": 0,
        "9": 0,
        "10": 0,
        "11": 0,
        "12": 0,
        "13": 0,
        "14": 0,
        "15": 0,
    },
    "frequency": {
        "0": "S",
        "1": "S",
        "2": "I",
        "3": "I",
        "4": "I",
        "5": "I",
        "6": "I",
        "7": "I",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "perPayCheck": {
        "0": 4101.85,
        "1": 2549.15,
        "2": 77.14,
        "3": 339.31,
        "4": 88.04,
        "5": 24.26,
        "6": 843.69,
        "7": 0,
        "8": 0,
        "9": 0,
        "10": 0,
        "11": 0,
        "12": 0,
        "13": 0,
        "14": 0,
        "15": 0,
    },
    "monthlyIncome": {
        "0": 8203.7,
        "1": 5098.3,
        "2": 176.57,
        "3": 806.56,
        "4": 77.43,
        "5": 53.98,
        "6": 1123.0,
        "7": 0,
        "8": 0,
        "9": 0,
        "10": 0,
        "11": 0,
        "12": 0,
        "13": 0,
        "14": 0,
        "15": 0,
    },
    "regularPayDay": {
        "0": "15,lastday",
        "1": "15,lastday",
        "2": "None",
        "3": "None",
        "4": "None",
        "5": "None",
        "6": "None",
        "7": "None",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "historicalPayDay": {
        "0": [
            "2022-09-30",
            "2022-10-14",
            "2022-10-31",
            "2022-11-15",
            "2022-11-30",
            "2022-12-15",
            "2022-12-30",
            "2023-01-13",
            "2023-01-31",
            "2023-02-28",
            "2023-03-10",
            "2023-03-15",
            "2023-03-31",
            "2023-04-14",
            "2023-04-28",
            "2023-05-15",
            "2023-05-31",
            "2023-06-15",
            "2023-06-30",
            "2023-07-14",
            "2023-07-31",
            "2023-08-15",
            "2023-08-31",
            "2023-09-15",
        ],
        "1": ["2022-09-15", "2022-09-30"],
        "2": [
            "2022-09-13",
            "2022-09-16",
            "2022-09-30",
            "2022-10-12",
            "2022-10-14",
            "2022-10-28",
            "2022-11-10",
            "2022-11-25",
            "2022-12-09",
            "2022-12-23",
            "2023-01-06",
            "2023-01-20",
            "2023-02-03",
            "2023-02-17",
            "2023-03-03",
            "2023-03-17",
            "2023-03-31",
            "2023-04-14",
            "2023-04-28",
            "2023-05-26",
            "2023-06-09",
            "2023-06-23",
            "2023-07-07",
            "2023-07-21",
            "2023-08-04",
            "2023-08-18",
            "2023-09-01",
            "2023-09-15",
        ],
        "3": [
            "2022-09-13",
            "2022-09-29",
            "2022-10-11",
            "2022-10-12",
            "2022-10-13",
            "2022-11-14",
            "2022-11-25",
            "2022-11-29",
            "2022-12-14",
            "2023-01-27",
            "2023-01-30",
            "2023-02-13",
            "2023-02-14",
            "2023-04-10",
            "2023-04-25",
            "2023-04-26",
            "2023-05-10",
            "2023-05-11",
            "2023-05-12",
            "2023-05-30",
            "2023-06-12",
            "2023-06-13",
            "2023-07-12",
            "2023-07-13",
            "2023-08-14",
            "2023-09-11",
            "2023-09-12",
            "2023-09-13",
            "2023-09-14",
        ],
        "4": [
            "2022-10-11",
            "2022-10-28",
            "2023-04-07",
            "2023-04-17",
            "2023-05-01",
            "2023-06-28",
            "2023-06-29",
            "2023-07-03",
            "2023-08-14",
        ],
        "5": [
            "2022-09-16",
            "2022-09-30",
            "2022-10-14",
            "2022-10-28",
            "2022-11-10",
            "2022-11-25",
            "2022-12-09",
            "2022-12-23",
            "2023-01-06",
            "2023-01-20",
            "2023-02-03",
            "2023-02-17",
            "2023-03-03",
            "2023-03-17",
            "2023-03-31",
            "2023-04-14",
            "2023-04-28",
            "2023-05-26",
            "2023-06-08",
            "2023-06-09",
            "2023-06-23",
            "2023-07-07",
            "2023-07-21",
            "2023-08-04",
            "2023-08-18",
            "2023-09-01",
            "2023-09-15",
        ],
        "6": [
            "2022-10-04",
            "2022-10-07",
            "2022-11-01",
            "2022-11-18",
            "2022-12-02",
            "2023-01-03",
            "2023-03-15",
            "2023-03-31",
            "2023-04-10",
            "2023-04-17",
            "2023-05-15",
            "2023-06-08",
            "2023-07-24",
        ],
        "7": ["2023-05-05"],
        "8": [],
        "9": [],
        "10": [],
        "11": [],
        "12": [],
        "13": [],
        "14": [],
        "15": [],
    },
    "missingPayDay": {
        "0": [],
        "1": [],
        "2": [],
        "3": [],
        "4": [],
        "5": [],
        "6": [],
        "7": [],
        "8": [],
        "9": [],
        "10": [],
        "11": [],
        "12": [],
        "13": [],
        "14": [],
        "15": [],
    },
    "sameDayFreq": {
        "0": 0.7083333333,
        "1": 1.0,
        "2": 0,
        "3": 0,
        "4": 0,
        "5": 0,
        "6": 0,
        "7": 0,
        "8": 0,
        "9": 0,
        "10": 0,
        "11": 0,
        "12": 0,
        "13": 0,
        "14": 0,
        "15": 0,
    },
    "lastPayDay": {
        "0": "2023-09-15",
        "1": "2022-09-30",
        "2": "2023-09-15",
        "3": "2023-09-14",
        "4": "2023-08-14",
        "5": "2023-09-15",
        "6": "2023-07-24",
        "7": "2023-05-05",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "incomeType": {
        "0": "Payroll",
        "1": "Payroll",
        "2": "Transfer",
        "3": "Transfer",
        "4": "Transfer",
        "5": "Transfer",
        "6": "Transfer",
        "7": "Transfer",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "depositType": {
        "0": "Direct Deposit",
        "1": "Direct Deposit",
        "2": "None",
        "3": "None",
        "4": "None",
        "5": "None",
        "6": "None",
        "7": "None",
        "8": "None",
        "9": "None",
        "10": "None",
        "11": "None",
        "12": "None",
        "13": "None",
        "14": "None",
        "15": "None",
    },
    "errorCode": {
        "0": 0,
        "1": 401,
        "2": 305,
        "3": 305,
        "4": 405,
        "5": 305,
        "6": 305,
        "7": 205,
        "8": 102,
        "9": 102,
        "10": 102,
        "11": 102,
        "12": 103,
        "13": 103,
        "14": 103,
        "15": 103,
    },
    "errorMessage": {
        "0": "NA",
        "1": "Income not seen within 18 days",
        "2": "Balance Transfer between one's own account is not income",
        "3": "Balance Transfer between one's own account is not income",
        "4": "Transfer not seen within 30 days",
        "5": "Balance Transfer between one's own account is not income",
        "6": "Balance Transfer between one's own account is not income",
        "7": "Transfer Deposit only occurred once on the same day",
        "8": "Benefit income not found",
        "9": "Benefit income not found",
        "10": "Benefit income not found",
        "11": "Benefit income not found",
        "12": "Gig income not found",
        "13": "Gig income not found",
        "14": "Gig income not found",
        "15": "Gig income not found",
    },
    "isDominant": {
        "0": 1,
        "1": 0,
        "2": 0,
        "3": 0,
        "4": 0,
        "5": 0,
        "6": 0,
        "7": 0,
        "8": 0,
        "9": 0,
        "10": 0,
        "11": 0,
        "12": 0,
        "13": 0,
        "14": 0,
        "15": 0,
    },
}
expected_dominant_income_type = {
    "accountGuid": {
        "0": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "1": "kPvjdQ8XK6hD3RE311j8fp7Mg9Z9R6F6qRDQd",
        "2": "AMpRdoAVarH4VZbV55XDHyMxLkEknYfY76BK5",
        "3": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
    },
    "incomeType": {
        "0": "Payroll",
        "1": "No Income Detected",
        "2": "No Income Detected",
        "3": "No Income Detected",
    },
}
expected_income_df_cols = [
    "accountGuid",
    "sourceID",
    "sourceName",
    "sourceType",
    "sourceChannel",
    "numOfPay",
    "numOfPayMonthly",
    "frequency",
    "perPayCheck",
    "monthlyIncome",
    "regularPayDay",
    "historicalPayDay",
    "missingPayDay",
    "sameDayFreq",
    "lastPayDay",
    "incomeType",
    "depositMethod",
    "errorCode",
    "errorMessage",
    "isDominant",
]


def test_rank_income_sources():
    balance_df = PostProcessTestData().balance_df
    income_df_sorted, dominant_income_type = rank_income_sources(
        expected_payroll_source_dict,
        expected_transf_source_dict,
        expected_benefit_source_dict,
        expected_gig_source_dict,
        balance_df,
    )
    assert len(income_df_sorted) == 16
    assert income_df_sorted.columns.to_list() == expected_income_df_cols
    assert len(dominant_income_type) == 4
    assert dominant_income_type.columns.to_list() == ["accountGuid", "incomeType"]
    assert dominant_income_type.columns.to_list() == ["accountGuid", "incomeType"]
