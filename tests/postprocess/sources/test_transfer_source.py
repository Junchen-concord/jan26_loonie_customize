from datetime import datetime

import pandas as pd
from data import PostProcessTestData

from postprocess.sources.income_source import IncomeSource
from postprocess.sources.transfer_source import TransferSource

expected_transf_source_dict = {
    "AMpRdoAVarH4VZbV55XDHyMxLkEknYfY76BK5_Balance Transfer": {
        "accountGuid": "AMpRdoAVarH4VZbV55XDHyMxLkEknYfY76BK5",
        "sourceID": "None",
        "sourceName": "Balance Transfer",
        "sourceType": "None",
        "sourceChannel": "None",
        "numOfPay": 28,
        "numOfPayMonthly": 0,
        "frequency": "I",
        "perPayCheck": 77.14,
        "monthlyIncome": 176.57,
        "regularPayDay": "None",
        "historicalPayDay": [
            "2022-09-13",
            "2022-09-16",
            "2022-09-30",
            "2022-10-12",
            "2022-10-14",
            "2022-10-28",
            "2022-11-10",
            "2022-11-25",
            "2022-12-09",
            "2022-12-23",
            "2023-01-06",
            "2023-01-20",
            "2023-02-03",
            "2023-02-17",
            "2023-03-03",
            "2023-03-17",
            "2023-03-31",
            "2023-04-14",
            "2023-04-28",
            "2023-05-26",
            "2023-06-09",
            "2023-06-23",
            "2023-07-07",
            "2023-07-21",
            "2023-08-04",
            "2023-08-18",
            "2023-09-01",
            "2023-09-15",
        ],
        "missingPayDay": [],
        "sameDayFreq": 0,
        "lastPayDay": "2023-09-15",
        "incomeType": "Transfer",
        "depositMethod": "Other",
        "errorCode": 305,
        "errorMessage": "Balance Transfer between one's own account is not income",
    },
    "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz_Balance Transfer": {
        "accountGuid": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "sourceID": "None",
        "sourceName": "Balance Transfer",
        "sourceType": "None",
        "sourceChannel": "None",
        "numOfPay": 29,
        "numOfPayMonthly": 0,
        "frequency": "I",
        "perPayCheck": 339.31,
        "monthlyIncome": 806.56,
        "regularPayDay": "None",
        "historicalPayDay": [
            "2022-09-13",
            "2022-09-29",
            "2022-10-11",
            "2022-10-12",
            "2022-10-13",
            "2022-11-14",
            "2022-11-25",
            "2022-11-29",
            "2022-12-14",
            "2023-01-27",
            "2023-01-30",
            "2023-02-13",
            "2023-02-14",
            "2023-04-10",
            "2023-04-25",
            "2023-04-26",
            "2023-05-10",
            "2023-05-11",
            "2023-05-12",
            "2023-05-30",
            "2023-06-12",
            "2023-06-13",
            "2023-07-12",
            "2023-07-13",
            "2023-08-14",
            "2023-09-11",
            "2023-09-12",
            "2023-09-13",
            "2023-09-14",
        ],
        "missingPayDay": [],
        "sameDayFreq": 0,
        "lastPayDay": "2023-09-14",
        "incomeType": "Transfer",
        "depositMethod": "Other",
        "errorCode": 305,
        "errorMessage": "Balance Transfer between one's own account is not income",
    },
    "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz_Venmo": {
        "accountGuid": "KwO4y1ZoL8HDVZJV7763fBZ9XbJbm8CnpQvrz",
        "sourceID": "I2_err_405",
        "sourceName": "Venmo",
        "sourceType": "None",
        "sourceChannel": "None",
        "numOfPay": 9,
        "numOfPayMonthly": 0,
        "frequency": "I",
        "perPayCheck": 88.04,
        "monthlyIncome": 77.43,
        "regularPayDay": "None",
        "historicalPayDay": [
            "2022-10-11",
            "2022-10-28",
            "2023-04-07",
            "2023-04-17",
            "2023-05-01",
            "2023-06-28",
            "2023-06-29",
            "2023-07-03",
            "2023-08-14",
        ],
        "missingPayDay": [],
        "sameDayFreq": 0,
        "lastPayDay": "2023-08-14",
        "incomeType": "Transfer",
        "depositMethod": "Other",
        "errorCode": 405,
        "errorMessage": "Transfer not seen within 30 days",
    },
    "kPvjdQ8XK6hD3RE311j8fp7Mg9Z9R6F6qRDQd_Balance Transfer": {
        "accountGuid": "kPvjdQ8XK6hD3RE311j8fp7Mg9Z9R6F6qRDQd",
        "sourceID": "None",
        "sourceName": "Balance Transfer",
        "sourceType": "None",
        "sourceChannel": "None",
        "numOfPay": 27,
        "numOfPayMonthly": 0,
        "frequency": "I",
        "perPayCheck": 24.26,
        "monthlyIncome": 53.98,
        "regularPayDay": "None",
        "historicalPayDay": [
            "2022-09-16",
            "2022-09-30",
            "2022-10-14",
            "2022-10-28",
            "2022-11-10",
            "2022-11-25",
            "2022-12-09",
            "2022-12-23",
            "2023-01-06",
            "2023-01-20",
            "2023-02-03",
            "2023-02-17",
            "2023-03-03",
            "2023-03-17",
            "2023-03-31",
            "2023-04-14",
            "2023-04-28",
            "2023-05-26",
            "2023-06-08",
            "2023-06-09",
            "2023-06-23",
            "2023-07-07",
            "2023-07-21",
            "2023-08-04",
            "2023-08-18",
            "2023-09-01",
            "2023-09-15",
        ],
        "missingPayDay": [],
        "sameDayFreq": 0,
        "lastPayDay": "2023-09-15",
        "incomeType": "Transfer",
        "depositMethod": "Other",
        "errorCode": 305,
        "errorMessage": "Balance Transfer between one's own account is not income",
    },
    "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM_Balance Transfer": {
        "accountGuid": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
        "sourceID": "None",
        "sourceName": "Balance Transfer",
        "sourceType": "None",
        "sourceChannel": "None",
        "numOfPay": 13,
        "numOfPayMonthly": 0,
        "frequency": "I",
        "perPayCheck": 843.69,
        "monthlyIncome": 1123.0,
        "regularPayDay": "None",
        "historicalPayDay": [
            "2022-10-04",
            "2022-10-07",
            "2022-11-01",
            "2022-11-18",
            "2022-12-02",
            "2023-01-03",
            "2023-03-15",
            "2023-03-31",
            "2023-04-10",
            "2023-04-17",
            "2023-05-15",
            "2023-06-08",
            "2023-07-24",
        ],
        "missingPayDay": [],
        "sameDayFreq": 0,
        "lastPayDay": "2023-07-24",
        "incomeType": "Transfer",
        "depositMethod": "Other",
        "errorCode": 305,
        "errorMessage": "Balance Transfer between one's own account is not income",
    },
    "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM_Other Transfer": {
        "accountGuid": "yx3EvQLkOjhPZD7ZKKpytynr9dMdOJfr4OomM",
        "sourceID": "I3_err_205",
        "sourceName": "Other Transfer",
        "sourceType": "None",
        "sourceChannel": "None",
        "numOfPay": 1,
        "numOfPayMonthly": 0,
        "frequency": "I",
        "perPayCheck": 1.08,
        "monthlyIncome": 1.08,
        "regularPayDay": "None",
        "historicalPayDay": ["2023-05-05"],
        "missingPayDay": [],
        "sameDayFreq": 0,
        "lastPayDay": "2023-05-05",
        "incomeType": "Transfer",
        "depositMethod": "Other",
        "errorCode": 205,
        "errorMessage": "Transfer/Deposit only occurred once/on the same day",
    },
}

expected_income_source_trans_columns = [
    "accountGuid",
    "transGUID",
    "sourceName",
    "description",
    "date",
    "amount",
    "transCategory",
    "cluster_label",
    "type",
    "fromModel",
    "WHO",
    "HOW",
    "WHAT",
    "whoCat",
    "dayOfWeek",
    "sourceID",
    "subcategory",
]


def test_categorize_income_source():
    df = PostProcessTestData().arg_for_categorize_income
    as_of_date = pd.to_datetime(datetime(2023, 9, 15))
    _, income_source_trans, sourceID = IncomeSource.categorize_income_source(df, as_of_date, 0)
    _, income_source_trans, sourceID = TransferSource.categorize_income_source(df, income_source_trans, as_of_date, 1)

    # Removing the exact match between output dictionary because of the rapid changing of output format,
    # to check specific fields, use test_QA_problems.py
    # assert transf_source_dict == expected_transf_source_dict
    assert len(income_source_trans) == 184
    assert len(income_source_trans.columns) == 17
    assert income_source_trans.columns.to_list() == expected_income_source_trans_columns
    assert sourceID == 3
